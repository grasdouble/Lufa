name: 'Build Design System'
description: 'Build design system packages with intelligent caching'

inputs:
  build-storybook:
    description: 'Whether to build Storybook'
    required: false
    default: 'false'
  build-docusaurus:
    description: 'Whether to build Docusaurus'
    required: false
    default: 'false'

outputs:
  cache-hit:
    description: 'Whether the design system build cache was hit'
    value: ${{ steps.cache-build.outputs.cache-hit }}
  storybook-cache-hit:
    description: 'Whether the Storybook build cache was hit'
    value: ${{ steps.cache-storybook.outputs.cache-hit }}
  docusaurus-cache-hit:
    description: 'Whether the Docusaurus build cache was hit'
    value: ${{ steps.cache-docusaurus.outputs.cache-hit }}

runs:
  using: 'composite'
  steps:
    - name: ğŸ“¦ Cache design system build
      id: cache-build
      uses: actions/cache@v4
      with:
        path: |
          packages/design-system/tokens/dist
          packages/design-system/themes/dist
          packages/design-system/main/dist
        key: ds-build-${{ runner.os }}-${{ hashFiles('packages/design-system/tokens/**/*.json', 'packages/design-system/themes/src/**/*', 'packages/design-system/main/src/**/*', 'packages/design-system/*/package.json') }}
        restore-keys: |
          ds-build-${{ runner.os }}-

    - name: ğŸ—ï¸ Build design tokens
      if: steps.cache-build.outputs.cache-hit != 'true'
      shell: bash
      run: pnpm ds:tokens:build

    - name: ğŸ—ï¸ Build design themes
      if: steps.cache-build.outputs.cache-hit != 'true'
      shell: bash
      run: pnpm ds:themes:build

    - name: ğŸ—ï¸ Build design system main
      if: steps.cache-build.outputs.cache-hit != 'true'
      shell: bash
      run: pnpm ds:main:build

    - name: ğŸ“¦ Cache Storybook build
      if: inputs.build-storybook == 'true'
      id: cache-storybook
      uses: actions/cache@v4
      with:
        path: packages/design-system/storybook/storybook-static
        key: storybook-build-${{ runner.os }}-${{ hashFiles('packages/design-system/storybook/**/*', 'packages/design-system/main/dist/**/*') }}
        restore-keys: |
          storybook-build-${{ runner.os }}-

    - name: ğŸ—ï¸ Build Storybook
      if: inputs.build-storybook == 'true' && steps.cache-storybook.outputs.cache-hit != 'true'
      shell: bash
      run: pnpm ds:storybook:build

    - name: ğŸ“¦ Cache Docusaurus build
      if: inputs.build-docusaurus == 'true'
      id: cache-docusaurus
      uses: actions/cache@v4
      with:
        path: packages/design-system/docusaurus/build
        key: docusaurus-build-${{ runner.os }}-${{ hashFiles('packages/design-system/docusaurus/**/*', 'packages/design-system/main/dist/**/*') }}
        restore-keys: |
          docusaurus-build-${{ runner.os }}-

    - name: ğŸ—ï¸ Build Docusaurus
      if: inputs.build-docusaurus == 'true' && steps.cache-docusaurus.outputs.cache-hit != 'true'
      shell: bash
      run: pnpm ds:docusaurus:build
