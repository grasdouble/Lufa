# Development Guidelines

This document provides development standards and best practices for contributing to the Lufa monorepo.

## Code Standards

### TypeScript

- **Use strict mode**: Enable `strict: true` in tsconfig.json
- **Type everything**: Avoid `any` types except when absolutely necessary
- **Use interfaces for objects**: Prefer interfaces over type aliases for object shapes
- **Export types**: Export all public types for reusability
- **Use const assertions**: For literal types and readonly objects

**Example:**

```typescript
// ✅ Good
interface ComponentProps {
  title: string;
  isActive: boolean;
  onClick: () => void;
}

export const Component = ({ title, isActive, onClick }: ComponentProps) => {
  // Implementation
};

// ❌ Avoid
export const Component = ({ title, isActive, onClick }: any) => {
  // Implementation
};
```

### React

- **Functional components**: Use function declarations for components
- **Hooks**: Use React hooks for state and side effects
- **Props**: Define props interface for all components
- **Exports**: Named exports for components, default export for pages
- **Files**: One component per file (unless closely related)

**Example:**

```typescript
// ✅ Good - ComponentName.tsx
interface ButtonProps {
  label: string;
  onClick: () => void;
  variant?: "primary" | "secondary";
}

export const Button = ({
  label,
  onClick,
  variant = "primary",
}: ButtonProps) => {
  return (
    <button onClick={onClick} className={variant}>
      {label}
    </button>
  );
};
```

### CSS/Styling

- **Tailwind CSS v4**: Use Tailwind utility classes
- **CSS-first configuration**: Configure in CSS files, not config files
- **Design tokens**: Use design tokens from `@grasdouble/lufa_design-system-tokens`
- **Semantic naming**: Use semantic class names for complex components
- **Dark mode**: Support dark mode using Tailwind's dark variant

**Example:**

```css
/* ✅ Good - Using design tokens */
@theme {
  --color-primary: #3b82f6;
  --color-secondary: #8b5cf6;
}

.button {
  @apply bg-primary text-white px-4 py-2 rounded;
}

/* Dark mode support */
.button {
  @apply dark:bg-gray-800 dark:text-gray-100;
}
```

### File Naming

- **Components**: PascalCase (e.g., `Button.tsx`, `UserProfile.tsx`)
- **Utilities**: camelCase (e.g., `formatDate.ts`, `apiClient.ts`)
- **Hooks**: camelCase with "use" prefix (e.g., `useAuth.ts`, `useLocalStorage.ts`)
- **Types**: PascalCase with `.types.ts` suffix (e.g., `User.types.ts`)
- **Constants**: UPPER_SNAKE_CASE or camelCase based on usage
- **Tests**: Same name as tested file with `.test.ts` or `.spec.ts` suffix

### Directory Structure

Each package should follow this structure:

```
package-name/
├── src/
│   ├── components/        # React components
│   ├── hooks/            # Custom React hooks
│   ├── utils/            # Utility functions
│   ├── types/            # TypeScript type definitions
│   ├── styles/           # CSS/styling files
│   └── index.ts          # Main entry point
├── tests/                # Test files
├── package.json
├── tsconfig.json
├── README.md
└── CHANGELOG.md          # Generated by changesets
```

## Git Workflow

### Branch Naming

Use descriptive branch names with prefixes:

- `feat/` - New features (e.g., `feat/add-button-component`)
- `fix/` - Bug fixes (e.g., `fix/button-click-handler`)
- `docs/` - Documentation updates (e.g., `docs/update-readme`)
- `refactor/` - Code refactoring (e.g., `refactor/simplify-api-client`)
- `test/` - Test additions or modifications (e.g., `test/add-button-tests`)
- `chore/` - Maintenance tasks (e.g., `chore/update-dependencies`)

### Commit Messages

Follow conventional commits format:

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Types:**

- `feat`: New feature
- `fix`: Bug fix
- `docs`: Documentation changes
- `style`: Code style changes (formatting, missing semi colons, etc.)
- `refactor`: Code refactoring
- `test`: Adding or updating tests
- `chore`: Maintenance tasks
- `perf`: Performance improvements
- `ci`: CI/CD changes

**Examples:**

```bash
feat(design-system): add Button component with variants

Add primary, secondary, and outline button variants with full accessibility support.

Closes #123

---

fix(microfrontend): resolve routing issue in home app

The home app was not properly handling route changes when navigating from external apps.

---

docs(architecture): update monorepo structure documentation

Added new packages and updated deployment information.
```

### Pull Request Process

1. **Create feature branch** from `main`
2. **Make changes** following code standards
3. **Add changeset** using `pnpm changeset`
4. **Write tests** if applicable
5. **Update documentation** if needed
6. **Push branch** and create pull request
7. **Ensure CI passes** (lint, tests, changeset check)
8. **Request review** if needed
9. **Merge** after approval and passing CI

### Changesets

Every PR that changes package functionality must include a changeset.

**Create a changeset:**

```bash
pnpm changeset
```

**Follow the prompts:**

1. Select packages that changed
2. Choose version bump type (major/minor/patch)
3. Describe the changes

**Changeset types:**

- **major**: Breaking changes (e.g., API changes, removed features)
- **minor**: New features (backwards compatible)
- **patch**: Bug fixes and minor improvements

## Testing

### Test Organization

- **Unit tests**: Test individual functions and components
- **Integration tests**: Test interactions between components
- **E2E tests**: Test full user workflows (to be implemented)

### Test File Location

Place test files next to the code they test:

```
src/
├── components/
│   ├── Button.tsx
│   └── Button.test.tsx
├── utils/
│   ├── formatDate.ts
│   └── formatDate.test.ts
```

### Writing Tests

```typescript
// ✅ Good test structure
describe("Button", () => {
  it("should render with correct label", () => {
    // Test implementation
  });

  it("should call onClick when clicked", () => {
    // Test implementation
  });

  it("should apply correct variant class", () => {
    // Test implementation
  });
});
```

## Package Development

### Creating a New Package

1. **Choose location**: Place in appropriate `packages/` subdirectory
2. **Initialize package**:

```bash
cd packages/[category]
mkdir [package-name]
cd [package-name]
pnpm init
```

3. **Configure package.json**:

```json
{
  "name": "@grasdouble/lufa_[category]_[name]",
  "version": "0.0.0",
  "private": false,
  "type": "module",
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/index.js",
      "types": "./dist/index.d.ts"
    }
  },
  "files": ["dist"],
  "scripts": {
    "build": "tsc",
    "dev": "tsc --watch",
    "lint": "eslint ."
  },
  "dependencies": {},
  "devDependencies": {
    "@grasdouble/lufa_config_typescript": "workspace:*",
    "typescript": "^5.0.0"
  }
}
```

4. **Add tsconfig.json**:

```json
{
  "extends": "@grasdouble/lufa_config_typescript/base.json",
  "compilerOptions": {
    "outDir": "./dist"
  },
  "include": ["src"]
}
```

5. **Create src/index.ts**
6. **Add to pnpm-workspace.yaml** if needed
7. **Add README.md** with package documentation

### Using Workspace Dependencies

Reference other workspace packages:

```json
{
  "dependencies": {
    "@grasdouble/lufa_design-system-primitives": "workspace:*"
  }
}
```

### Publishing Packages

Packages are automatically published when:

1. PRs with changesets are merged to `main`
2. Changesets bot creates version bump PR
3. Version bump PR is merged
4. Release workflow publishes to npm

**Mark package as private** to prevent publishing:

```json
{
  "private": true
}
```

## Code Review

### What to Look For

**Reviewers should check:**

- [ ] Code follows style guidelines
- [ ] TypeScript types are properly defined
- [ ] Tests are included for new functionality
- [ ] Documentation is updated
- [ ] Changeset is included (if needed)
- [ ] No security vulnerabilities introduced
- [ ] Performance considerations addressed
- [ ] Accessibility requirements met (for UI components)
- [ ] Dark mode support included (for UI components)

### Review Etiquette

- Be constructive and specific in feedback
- Ask questions rather than making demands
- Acknowledge good practices
- Suggest improvements, don't just point out problems
- Approve when ready, even with minor suggestions

## Performance

### General Guidelines

- **Code splitting**: Lazy load components when appropriate
- **Memoization**: Use `useMemo` and `useCallback` for expensive operations
- **Bundle size**: Monitor and optimize bundle size
- **Images**: Optimize images before committing
- **Dependencies**: Audit dependency size before adding

### React Performance

```typescript
// ✅ Good - Memoize expensive calculations
const expensiveValue = useMemo(() => {
  return complexCalculation(data);
}, [data]);

// ✅ Good - Memoize callbacks
const handleClick = useCallback(() => {
  doSomething(id);
}, [id]);

// ✅ Good - Lazy load components
const HeavyComponent = lazy(() => import("./HeavyComponent"));
```

## Accessibility

### Requirements

All UI components must be accessible:

- **Keyboard navigation**: Support tab, enter, escape, arrow keys
- **ARIA labels**: Add appropriate ARIA attributes
- **Semantic HTML**: Use semantic HTML elements
- **Color contrast**: Meet WCAG AA standards (4.5:1 for text)
- **Focus indicators**: Visible focus states
- **Screen readers**: Test with screen readers

**Example:**

```typescript
// ✅ Good - Accessible button
export const Button = ({ label, onClick }: ButtonProps) => {
  return (
    <button
      onClick={onClick}
      aria-label={label}
      className="focus:outline-none focus:ring-2 focus:ring-blue-500"
    >
      {label}
    </button>
  );
};
```

## Documentation

### Code Comments

- **Use JSDoc** for public APIs
- **Explain why, not what**: Code should be self-explanatory
- **Update comments**: Keep comments in sync with code
- **Remove dead code**: Delete unused code instead of commenting out

**Example:**

```typescript
/**
 * Formats a date to a human-readable string.
 *
 * @param date - The date to format
 * @param format - The desired format (default: 'short')
 * @returns Formatted date string
 *
 * @example
 * formatDate(new Date(), 'long') // "January 1, 2024"
 */
export function formatDate(
  date: Date,
  format: "short" | "long" = "short"
): string {
  // Implementation
}
```

### README Files

Every package should have a README with:

- Package name and description
- Installation instructions
- Usage examples
- API documentation
- Contributing guidelines (or link to main CONTRIBUTING.md)

### Storybook

UI components should have Storybook stories:

```typescript
// Button.stories.tsx
import type { Meta, StoryObj } from "@storybook/react";
import { Button } from "./Button";

const meta: Meta<typeof Button> = {
  title: "Components/Button",
  component: Button,
};

export default meta;
type Story = StoryObj<typeof Button>;

export const Primary: Story = {
  args: {
    label: "Click me",
    variant: "primary",
  },
};

export const Secondary: Story = {
  args: {
    label: "Click me",
    variant: "secondary",
  },
};
```

## Security

### Best Practices

- **Dependency audits**: Run `pnpm audit` regularly
- **Update dependencies**: Keep dependencies up to date
- **Environment variables**: Never commit secrets or API keys
- **Input validation**: Validate all user inputs
- **XSS prevention**: Sanitize user-generated content
- **HTTPS only**: Use HTTPS for all external requests

### Secrets Management

```bash
# ✅ Good - Use environment variables
const API_KEY = process.env.VITE_API_KEY;

# ❌ Never do this
const API_KEY = "sk-1234567890abcdef";
```

## Troubleshooting

### Common Issues

**Issue: Dependency not found after installation**

```bash
# Clear pnpm cache and reinstall
pnpm store prune
rm -rf node_modules
pnpm install
```

**Issue: TypeScript errors in IDE but builds successfully**

```bash
# Restart TypeScript server in VS Code
# CMD + Shift + P → "TypeScript: Restart TS Server"
```

**Issue: Changeset check failing in CI**

```bash
# Create a changeset
pnpm changeset

# Or create empty changeset if no packages changed
pnpm changeset --empty
```

**Issue: Storybook not loading components**

```bash
# Rebuild design system and restart Storybook
pnpm run build:lufa:ds
pnpm run dev:apps:storybook
```

## Resources

### Internal Documentation

- [Architecture Documentation](.github/ai/ARCHITECTURE.md)
- [Lufa Story](docs/LufaStory.md)
- [How-to Guides](docs/howto/)

### External Resources

- [pnpm Documentation](https://pnpm.io/)
- [TypeScript Handbook](https://www.typescriptlang.org/docs/)
- [React Documentation](https://react.dev/)
- [Tailwind CSS v4](https://v4.tailwindcss.com/)
- [Single-SPA](https://single-spa.js.org/)
- [Changesets](https://github.com/changesets/changesets)

---

**Questions?** Open an issue or discussion on GitHub.
