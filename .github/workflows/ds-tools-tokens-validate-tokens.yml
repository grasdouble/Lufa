name: DS:Tools:Tokens:Validate Token Usage

on:
  pull_request:
    paths:
      - 'packages/design-system/tokens/src/**/*.json'
      - 'packages/design-system/tokens/dist/**'
      - 'packages/design-system/main/src/**/*.css'
      - 'packages/design-system/main/src/**/*.ts'
      - 'packages/design-system/main/src/**/*.tsx'
      - 'packages/design-system/main/src/**/*.cjs'
      - 'packages/design-system/main/scripts/validate-token-usage.js'
      - 'packages/design-system/docusaurus/src/**/*.css'
      - 'packages/design-system/docusaurus/src/**/*.ts'
      - 'packages/design-system/docusaurus/src/**/*.tsx'
      - 'packages/design-system/docusaurus/scripts/validate-token-usage.js'
  push:
    branches:
      - main
    paths:
      - 'packages/design-system/tokens/src/**/*.json'
      - 'packages/design-system/tokens/dist/**'
      - 'packages/design-system/main/src/**/*.css'
      - 'packages/design-system/main/src/**/*.ts'
      - 'packages/design-system/main/src/**/*.tsx'
      - 'packages/design-system/main/src/**/*.cjs'
      - 'packages/design-system/main/scripts/validate-token-usage.js'
      - 'packages/design-system/docusaurus/src/**/*.css'
      - 'packages/design-system/docusaurus/src/**/*.ts'
      - 'packages/design-system/docusaurus/src/**/*.tsx'
      - 'packages/design-system/docusaurus/scripts/validate-token-usage.js'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-token-usage:
    name: Validate Token Usage
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ“¦ Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ“¦ Build tokens before validation
        run: pnpm ds:tokens:build

      # â”€â”€ DS Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: ğŸ” Validate token usage â€” DS Main
        id: validate-main
        run: |
          echo "::group::DS Main â€” Token Usage Validation"
          pnpm ds:main:validate:token-usage
          echo "::endgroup::"
        continue-on-error: true

      # â”€â”€ DS Docusaurus â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: ğŸ” Validate token usage â€” DS Docusaurus
        id: validate-docusaurus
        run: |
          echo "::group::DS Docusaurus â€” Token Usage Validation"
          pnpm ds:docusaurus:validate:token-usage
          echo "::endgroup::"
        continue-on-error: true

      # â”€â”€ PR Comment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: ğŸ’¬ Build validation comment
        if: github.event_name == 'pull_request'
        id: build-comment
        env:
          MAIN_OUTCOME: ${{ steps.validate-main.outcome }}
          DOCUSAURUS_OUTCOME: ${{ steps.validate-docusaurus.outcome }}
        run: |
          MAIN_STATUS="âœ… Passed"
          DOCUSAURUS_STATUS="âœ… Passed"
          [[ "$MAIN_OUTCOME" == "failure" ]] && MAIN_STATUS="âŒ Failed"
          [[ "$DOCUSAURUS_OUTCOME" == "failure" ]] && DOCUSAURUS_STATUS="âŒ Failed"

          # Only re-capture outputs when there are failures (avoids redundant runs on success)
          MAIN_OUTPUT=""
          DOCUSAURUS_OUTPUT=""
          if [[ "$MAIN_OUTCOME" == "failure" ]]; then
            MAIN_OUTPUT=$(pnpm ds:main:validate:token-usage 2>&1 | sed 's/\x1B\[[0-9;]*[mK]//g' || true)
          fi
          if [[ "$DOCUSAURUS_OUTCOME" == "failure" ]]; then
            DOCUSAURUS_OUTPUT=$(pnpm ds:docusaurus:validate:token-usage 2>&1 | sed 's/\x1B\[[0-9;]*[mK]//g' || true)
          fi

          {
            echo 'comment-body<<EOF_COMMENT'
            cat << EOF
          <!-- token-usage-validation-comment -->
          ## ğŸ” Design Token Usage Validation

          | Package | Status |
          |---|---|
          | DS Main | ${MAIN_STATUS} |
          | DS Docusaurus | ${DOCUSAURUS_STATUS} |

          $(if [[ "$MAIN_OUTCOME" == "failure" ]]; then
            cat << 'MAIN_SECTION'
          <details>
          <summary>ğŸ“‹ DS Main â€” Validation Report</summary>

          \`\`\`
          MAIN_SECTION
            echo "${MAIN_OUTPUT}"
            cat << 'MAIN_CLOSE'
          \`\`\`

          </details>
          MAIN_CLOSE
          fi)

          $(if [[ "$DOCUSAURUS_OUTCOME" == "failure" ]]; then
            cat << 'DOC_SECTION'
          <details>
          <summary>ğŸ“‹ DS Docusaurus â€” Validation Report</summary>

          \`\`\`
          DOC_SECTION
            echo "${DOCUSAURUS_OUTPUT}"
            cat << 'DOC_CLOSE'
          \`\`\`

          </details>
          DOC_CLOSE
          fi)

          $(if [[ "$MAIN_OUTCOME" == "failure" || "$DOCUSAURUS_OUTCOME" == "failure" ]]; then
            cat << 'FIX_SECTION'
          ### ğŸ’¡ How to Fix

          A token is referenced in source code but not defined in \`tokens/dist/tokens.css\`.

          - Check that the token exists in \`packages/design-system/tokens/src/\`
          - Run \`pnpm ds:tokens:build\` to regenerate \`tokens.css\` after any token change
          - ğŸ§ª Run locally: \`pnpm ds:main:validate:token-usage\` / \`pnpm ds:docusaurus:validate:token-usage\`
          FIX_SECTION
          fi)

          ---

          *Part of Lufa Design System v2.0 - Automated token usage validation*
          EOF
            echo 'EOF_COMMENT'
          } >> $GITHUB_OUTPUT

      - name: ğŸ’¬ Comment on PR with results
        if: github.event_name == 'pull_request'
        uses: ./.github/actions/pr-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-marker: '<!-- token-usage-validation-comment -->'
          comment-body: ${{ steps.build-comment.outputs.comment-body }}

      # â”€â”€ Final gate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      - name: âŒ Fail if any validation errors
        if: steps.validate-main.outcome == 'failure' || steps.validate-docusaurus.outcome == 'failure'
        run: |
          [[ "${{ steps.validate-main.outcome }}" == "failure" ]] && \
            echo "::error::DS Main token usage validation failed."
          [[ "${{ steps.validate-docusaurus.outcome }}" == "failure" ]] && \
            echo "::error::DS Docusaurus token usage validation failed."
          exit 1

      - name: âœ… All token usages are valid
        if: steps.validate-main.outcome == 'success' && steps.validate-docusaurus.outcome == 'success'
        run: echo "::notice::All token usages are valid in DS Main and DS Docusaurus."
