name: Tools:DS:Visual-Regression

on:
  pull_request:
    paths:
      - 'packages/design-system/main/src/**/*.tsx'
      - 'packages/design-system/main/src/**/*.ts'
      - 'packages/design-system/playwright/**/*.tsx'
      - 'packages/design-system/playwright/**/*.ts'
      - 'packages/design-system/tokens/**/*.json'
      - '.github/workflows/tools-ds-visual-regression.yml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6

      - name: ğŸ“¦ Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build design system
        uses: ./.github/actions/build-design-system
        with:
          build-storybook: 'false'
          build-docusaurus: 'false'

      - name: ğŸ­ Install Playwright browsers
        uses: ./.github/actions/install-playwright

      - name: ğŸ§ª Run visual regression tests
        id: test
        run: |
          echo "::group::Visual Regression Tests"
          pnpm --filter @grasdouble/lufa_design-system-playwright test-ct
          echo "::endgroup::"
        continue-on-error: true
        env:
          CI: true

      - name: ğŸ“Š Generate test report
        if: always()
        id: report
        run: |
          cd packages/design-system/playwright

          # Parse JSON results if available
          if [ -f "test-results/results.json" ]; then
            TOTAL_TESTS=$(jq '[.suites[].specs[]] | length' test-results/results.json)
            PASSED_TESTS=$(jq '[.suites[].specs[] | select(.tests[].results[].status == "passed" or .tests[].results[].status == "expected")] | length' test-results/results.json)
            FAILED_TESTS=$(jq '[.suites[].specs[] | select(.tests[].results[].status == "failed" or .tests[].results[].status == "timedOut")] | length' test-results/results.json)
          elif [ -f "test-results/junit.xml" ]; then
            # Fallback to JUnit XML parsing
            TOTAL_TESTS=$(grep -c "<testcase" test-results/junit.xml || echo "0")
            PASSED_TESTS=$(grep -c "<testcase" test-results/junit.xml | grep -v "<failure" || echo "0")
            FAILED_TESTS=$(grep -c "<failure" test-results/junit.xml || echo "0")
          else
            # Last resort: count test result directories
            TOTAL_TESTS=$(find test-results -type d -name "*chromium*" 2>/dev/null | wc -l | tr -d ' ' || echo "0")
            PASSED_TESTS=$(find test-results -type d -name "*chromium*" ! -name "*retry*" 2>/dev/null | wc -l | tr -d ' ' || echo "0")
            FAILED_TESTS=$(find test-results -type d -name "*retry*" 2>/dev/null | wc -l | tr -d ' ' || echo "0")
          fi

          # Count visual diffs
          VISUAL_DIFFS=$(find test-results -name "*-diff.png" 2>/dev/null | wc -l | tr -d ' ' || echo "0")

          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "visual_diffs=$VISUAL_DIFFS" >> $GITHUB_OUTPUT

          if [ "$FAILED_TESTS" -eq "0" ] && [ "$TOTAL_TESTS" -gt "0" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¦ Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: visual-regression-results
          path: |
            packages/design-system/playwright/test-results/
            packages/design-system/playwright/playwright-report/
          retention-days: 7

      - name: ğŸ“¦ Upload visual diffs
        if: steps.report.outputs.visual_diffs != '0'
        uses: actions/upload-artifact@v6
        with:
          name: visual-diffs
          path: packages/design-system/playwright/test-results/**/*-diff.png
          retention-days: 14

      - name: ğŸ“¦ Upload baseline snapshots
        if: steps.report.outputs.visual_diffs != '0'
        uses: actions/upload-artifact@v6
        with:
          name: baseline-snapshots
          path: packages/design-system/playwright/__snapshots__/**/*.png
          retention-days: 7

      - name: ğŸ“ Build PR comment body
        if: github.event_name == 'pull_request' && always()
        id: comment
        env:
          STATUS: ${{ steps.report.outputs.status }}
          TOTAL_TESTS: ${{ steps.report.outputs.total_tests }}
          PASSED_TESTS: ${{ steps.report.outputs.passed_tests }}
          FAILED_TESTS: ${{ steps.report.outputs.failed_tests }}
          VISUAL_DIFFS: ${{ steps.report.outputs.visual_diffs }}
          RUN_ID: ${{ github.run_id }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          ARTIFACT_URL="https://github.com/${REPO_OWNER}/${REPO_NAME}/actions/runs/${RUN_ID}"

          cat << 'EOF' > comment.md
          <!-- visual-regression-results -->
          ## ğŸ¨ Visual Regression Test Results

          EOF

          if [ "$STATUS" = "success" ]; then
            cat << 'EOF' >> comment.md
          ### âœ… All Visual Tests Passed!

          No visual regressions detected. All components render as expected! ğŸ‰

          EOF
          else
            cat << 'EOF' >> comment.md
          ### âš ï¸ Visual Differences Detected

          Some components have visual changes. Please review the differences below.

          EOF
          fi

          cat << EOF >> comment.md
          | Metric | Count |
          |--------|-------|
          | Total Tests | ${TOTAL_TESTS} |
          | Passed | ${PASSED_TESTS} $([ "$STATUS" = "success" ] && echo "âœ…" || echo "") |
          | Failed | ${FAILED_TESTS} $([ "$STATUS" != "success" ] && echo "âŒ" || echo "") |
          | Visual Diffs | ${VISUAL_DIFFS} $([ "$VISUAL_DIFFS" != "0" ] && echo "ğŸ”" || echo "") |

          EOF

          if [ "$VISUAL_DIFFS" != "0" ]; then
            cat << EOF >> comment.md
          ### ğŸ“¸ Visual Differences

          ${VISUAL_DIFFS} component(s) have visual differences from the baseline snapshots.

          **Review Artifacts:**
          - [ğŸ“¦ Visual Diffs](${ARTIFACT_URL}#artifacts) - Download diff images
          - [ğŸ“Š Test Report](${ARTIFACT_URL}#artifacts) - Full Playwright HTML report
          - [ğŸ–¼ï¸ Baseline Snapshots](${ARTIFACT_URL}#artifacts) - Current baseline images

          ### ğŸ’¡ How to Review

          1. Download the \`visual-diffs\` artifact from the [Actions run](${ARTIFACT_URL})
          2. Review each diff image (red = removed, green = added)
          3. If changes are intentional:
             - Add label \`snapshot-update\` to this PR
             - Automated workflow will update baselines
          4. If changes are unintentional:
             - Fix the component code
             - Push changes to re-run tests

          EOF
          fi

          cat << 'EOF' >> comment.md
          ### ğŸ“‹ Components Tested

          All design system components were tested in:
          - â˜€ï¸ Light mode
          - ğŸŒ™ Dark mode
          - ğŸ’» Desktop viewport (1280x720)

          **Tested Components:**
          - Box, Stack, Text, Icon
          - Button, Badge, Divider
          - Center, Container, Flex, Grid
          - Portal, VisuallyHidden, Label
          - Input, Card (compositions)

          EOF

          if [ "$STATUS" != "success" ]; then
            cat << EOF >> comment.md
          ### ğŸ”§ Troubleshooting

          **Common causes of visual differences:**
          1. **Token changes** - Updated design tokens affect component styling
          2. **CSS changes** - Modified component styles or utility classes
          3. **Font changes** - Font family or weight modifications
          4. **Layout changes** - Padding, margin, or sizing adjustments
          5. **Browser updates** - Rendering engine differences

          **Run tests locally:**
          \`\`\`bash
          # Run visual tests
          pnpm ds:test:ci

          # Update snapshots if changes are intentional
          pnpm ds:test:update-snapshots
          \`\`\`

          EOF
          fi

          cat << EOF >> comment.md
          ---

          *Part of Lufa Design System v2.0 - Automated visual regression testing (Phase 7c)*
          *ğŸ“Š [View full test report](${ARTIFACT_URL})*
          EOF

          echo "body<<EOFMARKER" >> $GITHUB_OUTPUT
          cat comment.md >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT

      - name: ğŸ’¬ Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: ./.github/actions/pr-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-marker: '<!-- visual-regression-results -->'
          comment-body: ${{ steps.comment.outputs.body }}

      - name: âŒ Fail if visual differences detected
        if: steps.report.outputs.status == 'failure'
        run: |
          echo "::error::Visual regression tests failed. Review the diff images and update snapshots if changes are intentional."
          exit 1

      - name: âœ… Tests passed
        if: steps.report.outputs.status == 'success'
        run: |
          echo "::notice::All visual regression tests passed! ğŸ‰"

  update-snapshots:
    name: Update Snapshots
    runs-on: ubuntu-latest
    timeout-minutes: 60
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'snapshot-update')

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ”§ Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: ğŸ“¦ Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ—ï¸ Build design system
        uses: ./.github/actions/build-design-system
        with:
          build-storybook: 'false'
          build-docusaurus: 'false'

      - name: ğŸ­ Install Playwright browsers
        uses: ./.github/actions/install-playwright

      - name: ğŸ”„ Update snapshots
        run: pnpm --filter @grasdouble/lufa_design-system-playwright test-ct --update-snapshots
        env:
          CI: true

      - name: ğŸ› ï¸ Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: ğŸ’¾ Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-oxipng-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-oxipng-

      - name: ğŸ“¦ Install oxipng
        run: |
          if ! command -v oxipng &> /dev/null; then
            echo "Installing oxipng via cargo..."
            cargo install oxipng
          else
            echo "oxipng already cached"
          fi
          oxipng --version

      - name: ğŸ—œï¸ Compress snapshots
        run: pnpm ds:test:compress-snapshots

      - name: ğŸ’¾ Commit and push snapshots
        id: commit
        run: |
          git add packages/design-system/playwright/__snapshots__/

          if git diff --staged --quiet; then
            echo "No snapshot changes detected"
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            git commit -m "test: update visual regression snapshots (automated)"
            git push
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ”„ Trigger tests on updated snapshots
        if: steps.commit.outputs.updated == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            await new Promise(resolve => setTimeout(resolve, 5000));
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'tools-ds-visual-regression.yml',
                ref: '${{ github.event.pull_request.head.ref }}'
              });
            } catch (error) {
              console.error('Failed to trigger workflow:', error.message);
            }

      - name: ğŸ’¬ Comment on PR - Success
        if: steps.commit.outputs.updated == 'true'
        uses: ./.github/actions/pr-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-marker: '<!-- visual-regression-snapshot-update -->'
          comment-body: |
            <!-- visual-regression-snapshot-update -->
            âœ… **Visual regression snapshots updated!**

            - Updated and compressed snapshots
            - Commit SHA: `${{ steps.commit.outputs.sha }}`
            - Tests triggered automatically

            **Next:** Pull latest changes and review in "Files changed"

      - name: ğŸ’¬ Comment on PR - No changes
        if: steps.commit.outputs.updated == 'false'
        uses: ./.github/actions/pr-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-marker: '<!-- visual-regression-snapshot-update -->'
          comment-body: |
            <!-- visual-regression-snapshot-update -->
            â„¹ï¸ **No snapshot changes needed**

            Existing snapshots are already up to date.

      - name: ğŸ·ï¸ Remove snapshot-update label
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'snapshot-update'
              })
            } catch (error) {
              console.log('Could not remove label:', error.message)
            }
