name: Tools:DS:Visual-Regression

on:
  pull_request:
    paths:
      - 'packages/design-system/main/src/**/*.tsx'
      - 'packages/design-system/main/src/**/*.ts'
      - 'packages/design-system/playwright/**/*.tsx'
      - 'packages/design-system/playwright/**/*.ts'
      - 'packages/design-system/tokens/**/*.json'
      - '.github/workflows/tools-ds-visual-regression.yml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v6

      - name: üì¶ Install pnpm
        uses: pnpm/action-setup@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: .tool-versions
          cache: 'pnpm'

      - name: üì• Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üé≠ Install Playwright browsers
        run: pnpm --filter @grasdouble/lufa_design-system-playwright exec playwright install --with-deps chromium

      - name: üèóÔ∏è Build design system
        run: |
          pnpm ds:tokens:build
          pnpm ds:themes:build
          pnpm ds:main:build

      - name: üß™ Run visual regression tests
        id: test
        run: |
          echo "::group::Visual Regression Tests"
          pnpm --filter @grasdouble/lufa_design-system-playwright test-ct --project=chromium
          echo "::endgroup::"
        continue-on-error: true
        env:
          CI: true

      - name: üìä Generate test report
        if: always()
        id: report
        run: |
          cd packages/design-system/playwright

          # Count test results
          TOTAL_TESTS=$(find test-results -name "*.xml" 2>/dev/null | wc -l || echo "0")
          PASSED_TESTS=$(grep -r "status=\"passed\"" test-results 2>/dev/null | wc -l || echo "0")
          FAILED_TESTS=$(grep -r "status=\"failed\"" test-results 2>/dev/null | wc -l || echo "0")

          # Count visual diffs
          VISUAL_DIFFS=$(find test-results -name "*-diff.png" 2>/dev/null | wc -l || echo "0")

          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "visual_diffs=$VISUAL_DIFFS" >> $GITHUB_OUTPUT

          if [ "$FAILED_TESTS" -eq "0" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: üì¶ Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: visual-regression-results
          path: |
            packages/design-system/playwright/test-results/
            packages/design-system/playwright/playwright-report/
          retention-days: 7

      - name: üì¶ Upload visual diffs
        if: steps.report.outputs.visual_diffs != '0'
        uses: actions/upload-artifact@v6
        with:
          name: visual-diffs
          path: packages/design-system/playwright/test-results/**/*-diff.png
          retention-days: 14

      - name: üì¶ Upload baseline snapshots
        if: steps.report.outputs.visual_diffs != '0'
        uses: actions/upload-artifact@v6
        with:
          name: baseline-snapshots
          path: packages/design-system/playwright/__snapshots__/**/*.png
          retention-days: 7

      - name: üí¨ Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const status = '${{ steps.report.outputs.status }}';
            const totalTests = '${{ steps.report.outputs.total_tests }}';
            const passedTests = '${{ steps.report.outputs.passed_tests }}';
            const failedTests = '${{ steps.report.outputs.failed_tests }}';
            const visualDiffs = '${{ steps.report.outputs.visual_diffs }}';

            const runId = context.runId;
            const artifactUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`;

            let commentBody = `## üé® Visual Regression Test Results\n\n`;

            if (status === 'success') {
              commentBody += `### ‚úÖ All Visual Tests Passed!\n\n`;
              commentBody += `No visual regressions detected. All components render as expected! üéâ\n\n`;
            } else {
              commentBody += `### ‚ö†Ô∏è Visual Differences Detected\n\n`;
              commentBody += `Some components have visual changes. Please review the differences below.\n\n`;
            }

            // Test summary table
            commentBody += `| Metric | Count |\n`;
            commentBody += `|--------|-------|\n`;
            commentBody += `| Total Tests | ${totalTests} |\n`;
            commentBody += `| Passed | ${passedTests} ${status === 'success' ? '‚úÖ' : ''} |\n`;
            commentBody += `| Failed | ${failedTests} ${status !== 'success' ? '‚ùå' : ''} |\n`;
            commentBody += `| Visual Diffs | ${visualDiffs} ${visualDiffs !== '0' ? 'üîç' : ''} |\n\n`;

            if (visualDiffs !== '0') {
              commentBody += `### üì∏ Visual Differences\n\n`;
              commentBody += `${visualDiffs} component(s) have visual differences from the baseline snapshots.\n\n`;
              commentBody += `**Review Artifacts:**\n`;
              commentBody += `- [üì¶ Visual Diffs](${artifactUrl}#artifacts) - Download diff images\n`;
              commentBody += `- [üìä Test Report](${artifactUrl}#artifacts) - Full Playwright HTML report\n`;
              commentBody += `- [üñºÔ∏è Baseline Snapshots](${artifactUrl}#artifacts) - Current baseline images\n\n`;
              
              commentBody += `### üí° How to Review\n\n`;
              commentBody += `1. Download the \`visual-diffs\` artifact from the [Actions run](${artifactUrl})\n`;
              commentBody += `2. Review each diff image (red = removed, green = added)\n`;
              commentBody += `3. If changes are intentional:\n`;
              commentBody += `   - Add label \`snapshot-update\` to this PR\n`;
              commentBody += `   - Automated workflow will update baselines\n`;
              commentBody += `4. If changes are unintentional:\n`;
              commentBody += `   - Fix the component code\n`;
              commentBody += `   - Push changes to re-run tests\n\n`;
            }

            // Components tested
            commentBody += `### üìã Components Tested\n\n`;
            commentBody += `All design system components were tested in:\n`;
            commentBody += `- ‚òÄÔ∏è Light mode\n`;
            commentBody += `- üåô Dark mode\n`;
            commentBody += `- üíª Desktop viewport (1280x720)\n\n`;

            commentBody += `**Tested Components:**\n`;
            commentBody += `- Box, Stack, Text, Icon\n`;
            commentBody += `- Button, Badge, Divider\n`;
            commentBody += `- Center, Container, Flex, Grid\n`;
            commentBody += `- Portal, VisuallyHidden, Label\n`;
            commentBody += `- Input, Card (compositions)\n\n`;

            if (status !== 'success') {
              commentBody += `### üîß Troubleshooting\n\n`;
              commentBody += `**Common causes of visual differences:**\n`;
              commentBody += `1. **Token changes** - Updated design tokens affect component styling\n`;
              commentBody += `2. **CSS changes** - Modified component styles or utility classes\n`;
              commentBody += `3. **Font changes** - Font family or weight modifications\n`;
              commentBody += `4. **Layout changes** - Padding, margin, or sizing adjustments\n`;
              commentBody += `5. **Browser updates** - Rendering engine differences\n\n`;

              commentBody += `**Run tests locally:**\n`;
              commentBody += `\`\`\`bash\n`;
              commentBody += `# Run visual tests\n`;
              commentBody += `pnpm ds:test\n\n`;
              commentBody += `# Update snapshots if changes are intentional\n`;
              commentBody += `pnpm ds:test:update-snapshots\n`;
              commentBody += `\`\`\`\n\n`;
            }

            commentBody += `---\n\n`;
            commentBody += `*Part of Lufa Design System v2.0 - Automated visual regression testing (Phase 7c)*\n`;
            commentBody += `*üìä [View full test report](${artifactUrl})*`;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Visual Regression Test Results')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: ‚ùå Fail if visual differences detected
        if: steps.report.outputs.status == 'failure'
        run: |
          echo "::error::Visual regression tests failed. Review the diff images and update snapshots if changes are intentional."
          exit 1

      - name: ‚úÖ Tests passed
        if: steps.report.outputs.status == 'success'
        run: |
          echo "::notice::All visual regression tests passed! üéâ"
