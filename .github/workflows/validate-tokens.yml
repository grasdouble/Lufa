name: Validate Design Tokens

on:
  pull_request:
    paths:
      - 'packages/design-system/tokens/src/**/*.json'
      - 'scripts/validate-token-metadata.js'
  push:
    branches:
      - main
    paths:
      - 'packages/design-system/tokens/src/**/*.json'
      - 'scripts/validate-token-metadata.js'
  workflow_dispatch:

jobs:
  validate-tokens:
    name: Validate Token Metadata
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.9.0'

      - name: ğŸ” Run token validation
        id: validate
        run: |
          echo "::group::Token Validation"
          node scripts/validate-token-metadata.js
          echo "::endgroup::"
        continue-on-error: true

      - name: ğŸ’¬ Comment on PR with results
        if: github.event_name == 'pull_request' && steps.validate.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');

            // Re-run validation to capture output
            let output;
            try {
              output = execSync('node scripts/validate-token-metadata.js', { encoding: 'utf-8' });
            } catch (error) {
              output = error.stdout || error.message;
            }

            // Parse validation errors
            const hasErrors = output.includes('â”â”â” ERRORS');
            const errorCount = (output.match(/âœ— Tokens with Errors: (\d+)/)?.[1]) || '0';
            const warningCount = (output.match(/âš  Warnings: (\d+)/)?.[1]) || '0';

            let commentBody = `## ğŸ” Design Token Validation\n\n`;

            if (hasErrors) {
              commentBody += `### âŒ Validation Failed\n\n`;
              commentBody += `**Errors:** ${errorCount} | **Warnings:** ${warningCount}\n\n`;
              commentBody += `<details>\n<summary>ğŸ“‹ Validation Report</summary>\n\n\`\`\`\n${output}\n\`\`\`\n\n</details>\n\n`;
              commentBody += `### ğŸ’¡ How to Fix\n\n`;
              commentBody += `All tokens must include:\n\n`;
              commentBody += `1. **\`$description\`** - Meaningful description (min 10 chars)\n`;
              commentBody += `   - âœ… Good: "Primary brand color used for buttons, links, and key actions"\n`;
              commentBody += `   - âŒ Bad: "Primary color"\n\n`;
              commentBody += `2. **\`$type\`** - Valid DTCG type (color, dimension, fontFamily, etc.)\n\n`;
              commentBody += `3. **\`$extensions.lufa.themable\`** - Set to \`true\` or \`false\`\n\n`;
              commentBody += `### ğŸ“š Resources\n\n`;
              commentBody += `- ğŸ“– [Your First Token Guide](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/contributors/your-first-token.md)\n`;
              commentBody += `- âœ‚ï¸ Use VSCode snippets: \`.vscode/lufa-tokens.code-snippets\`\n`;
              commentBody += `- ğŸ§ª Run locally: \`pnpm validate:tokens\`\n\n`;
              commentBody += `---\n\n`;
              commentBody += `*Part of Lufa Design System v2.0 - Automated token validation*`;
            } else {
              commentBody += `### âœ… All Tokens Valid!\n\n`;
              commentBody += `All design tokens have proper metadata. Great work! ğŸ‰`;
            }

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.data.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Design Token Validation')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

      - name: âŒ Fail if validation errors
        if: steps.validate.outcome == 'failure'
        run: |
          echo "::error::Token validation failed. See validation report above."
          exit 1

      - name: âœ… Validation successful
        if: steps.validate.outcome == 'success'
        run: |
          echo "::notice::All tokens have valid metadata!"
