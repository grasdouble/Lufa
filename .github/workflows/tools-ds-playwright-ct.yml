name: Tools:DS:Playwright:Component-Tests

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to test'
        required: false
        type: number

permissions:
  contents: write # For pushing snapshot updates
  pull-requests: write # For commenting test results
  actions: write # For triggering workflows
  checks: none
  deployments: none
  issues: none
  packages: none
  repository-projects: none
  security-events: none
  statuses: none

jobs:
  playwright-component-tests:
    name: Playwright Component Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Skip tests when snapshot-update label is present - wait for snapshot update job to complete
    if: |
      !(github.event_name == 'pull_request' && 
        github.event.action == 'labeled' && 
        github.event.label.name == 'snapshot-update')

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v6

      - name: üì¶ Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üèóÔ∏è Build design system
        uses: ./.github/actions/build-design-system
        with:
          build-storybook: 'false'
          build-docusaurus: 'false'

      # Step 5: Install Playwright browsers
      - name: Install Playwright browsers
        uses: ./.github/actions/install-playwright

      # Step 6: Run Playwright component tests (Chromium only for CI speed)
      - name: Run Playwright component tests
        run: pnpm --filter @grasdouble/lufa_design-system-playwright test-ct --project=chromium
        env:
          CI: true

      # Step 7: Upload test results on failure
      - name: Upload test results
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-test-results
          path: packages/design-system/playwright/test-results/
          retention-days: 7

      # Step 8: Upload Playwright trace on failure
      - name: Upload Playwright trace
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-trace
          path: packages/design-system/playwright/test-results/**/*.zip
          retention-days: 7

      # Step 9: Upload HTML report on failure
      - name: Upload HTML report
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-html-report
          path: packages/design-system/playwright/playwright-report/
          retention-days: 7

  update-linux-snapshots:
    name: Update Linux Snapshots
    runs-on: ubuntu-latest
    timeout-minutes: 60
    # Only run when the 'snapshot-update' label is added to a PR
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'snapshot-update')

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: üîß Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: üì¶ Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üèóÔ∏è Build design system
        uses: ./.github/actions/build-design-system
        with:
          build-storybook: 'false'
          build-docusaurus: 'false'

      # Step 4: Install Playwright browsers
      - name: Install Playwright browsers
        uses: ./.github/actions/install-playwright

      # Step 6: Update Linux snapshots
      - name: Update Linux snapshots
        run: pnpm --filter @grasdouble/lufa_design-system-playwright test-ct --update-snapshots --project=chromium
        env:
          CI: true

      # Step 7: Setup Rust toolchain
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # Step 8: Cache cargo dependencies
      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-oxipng-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-oxipng-

      # Step 9: Install oxipng
      - name: Install oxipng
        run: |
          # Check if oxipng is already cached
          if ! command -v oxipng &> /dev/null; then
            echo "Installing oxipng via cargo..."
            cargo install oxipng
          else
            echo "oxipng already cached"
          fi

          # Verify installation
          oxipng --version

      # Step 10: Compress snapshots (level 6 for CI artifacts)
      - name: Compress snapshots
        run: pnpm ds:test:compress-snapshots
        # Note: We compress manually with level 6 (maximum) before committing.
        # The pre-commit hook (level 3) will run during git commit but won't
        # re-compress already optimized files. This ensures CI snapshots get
        # maximum compression (~10% better than level 3) while the hook still
        # validates that compression is working correctly.

      # Step 11: Commit and push updated snapshots
      - name: Commit and push snapshots
        id: commit
        run: |
          git add packages/design-system/playwright/__snapshots__/

          # Check if there are any changes
          if git diff --staged --quiet; then
            echo "No snapshot changes detected"
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            # Pre-commit hook will run here but won't re-compress (files already optimized)
            git commit -m "test: update Linux snapshots (automated)"
            git push
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          fi

      # Step 12: Trigger test workflow on the new commit
      - name: Trigger tests on updated snapshots
        if: steps.commit.outputs.updated == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            // Wait for the push to be processed
            console.log('Waiting 5 seconds for push to be processed...');
            await new Promise(resolve => setTimeout(resolve, 5000));

            // Trigger the workflow again with workflow_dispatch
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'tools-ds-playwright-ct.yml',
                ref: '${{ github.event.pull_request.head.ref }}',
                inputs: {
                  pr_number: String(context.issue.number)
                }
              });
              console.log('Successfully triggered workflow for PR #' + context.issue.number);
            } catch (error) {
              console.error('Failed to trigger workflow:', error.message);
              // Non-blocking error - tests will still run on next push
            }

      # Step 15: Comment on PR - Success
      - name: Comment on PR - Success
        if: steps.commit.outputs.updated == 'true'
        uses: ./.github/actions/pr-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-marker: '<!-- playwright-ct-results -->'
          comment-body: |
            <!-- playwright-ct-results -->
            ‚úÖ Linux snapshots have been updated and compressed!

            **Changes:**
            - Updated Linux snapshots in `packages/design-system/playwright/__snapshots__/`
            - Compressed snapshots using oxipng (level 6)
            - Committed with message: "test: update Linux snapshots (automated)"
            - New commit SHA: `${{ steps.commit.outputs.sha }}`

            **Next steps:**
            1. ‚úÖ Workflow has been triggered to run tests on updated snapshots
            2. Pull the latest changes: `git pull`
            3. Review the snapshot changes in the "Files changed" tab
            4. Merge when tests pass

            _The `snapshot-update` label has been automatically removed._

      # Step 16: Comment on PR - No changes
      - name: Comment on PR - No changes
        if: steps.commit.outputs.updated == 'false'
        uses: ./.github/actions/pr-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-marker: '<!-- playwright-ct-results -->'
          comment-body: |
            <!-- playwright-ct-results -->
            ‚ÑπÔ∏è No snapshot changes detected.

            The existing Linux snapshots are already up to date.

            _The `snapshot-update` label has been automatically removed._

      # Step 17: Remove snapshot-update label
      - name: Remove snapshot-update label
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'snapshot-update'
              })
              console.log('Label removed successfully')
            } catch (error) {
              // Label might already be removed or not exist
              console.log('Could not remove label:', error.message)
            }
