name: Tools:DS:Playwright:Component-Tests

on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to test'
        required: false
        type: number

permissions:
  contents: write # For pushing snapshot updates
  pull-requests: write # For commenting test results
  actions: write # For triggering workflows
  checks: none
  deployments: none
  issues: none
  packages: none
  repository-projects: none
  security-events: none
  statuses: none

jobs:
  playwright-component-tests:
    name: Playwright Component Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Skip tests when snapshot-update label is present - wait for snapshot update job to complete
    if: |
      !(github.event_name == 'pull_request' && 
        github.event.action == 'labeled' && 
        github.event.label.name == 'snapshot-update')

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v6

      - name: üì¶ Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üèóÔ∏è Build design system
        uses: ./.github/actions/build-design-system
        with:
          build-storybook: 'false'
          build-docusaurus: 'false'

      # Step 5: Install Playwright browsers
      - name: üé≠ Install Playwright browsers
        uses: ./.github/actions/install-playwright

      # Step 6: Run Playwright component tests (Chromium only for CI speed)
      - name: üß™ Run Playwright component tests
        id: test
        run: |
          TEST_START=$(date +%s%3N)
          pnpm --filter @grasdouble/lufa_design-system-playwright test-ct
          TEST_EXIT=$?
          TEST_END=$(date +%s%3N)
          TEST_TIME=$((TEST_END - TEST_START))
          TEST_TIME_SEC=$(echo "scale=2; $TEST_TIME / 1000" | bc)
          echo "test_time_sec=${TEST_TIME_SEC}" >> $GITHUB_OUTPUT
          exit $TEST_EXIT
        continue-on-error: true
        env:
          CI: true

      # Step 6b: Generate test metrics
      - name: üìä Generate test metrics
        if: always()
        id: metrics
        run: |
          cd packages/design-system/playwright

          echo "::group::Debug - Listing files"
          echo "Current directory: $(pwd)"
          echo "Files in test-results:"
          ls -la test-results/ || echo "test-results directory not found"
          if [ -f "test-results/results.json" ]; then
            echo "results.json exists, first 50 lines:"
            head -50 test-results/results.json
          fi
          if [ -f "test-results/junit.xml" ]; then
            echo "junit.xml exists, first 20 lines:"
            head -20 test-results/junit.xml
          fi
          echo "::endgroup::"

          # Parse JSON results if available
          if [ -f "test-results/results.json" ]; then
            echo "::group::Parsing JSON results"
            # Playwright JSON report uses nested suites, so we need recursive descent to find all specs
            TOTAL_TESTS=$(jq '[.. | .specs? // empty | .[]] | length' test-results/results.json 2>/dev/null || echo "0")
            PASSED_TESTS=$(jq '[.. | .specs? // empty | .[] | select(.ok == true)] | length' test-results/results.json 2>/dev/null || echo "0")
            FAILED_TESTS=$(jq '[.. | .specs? // empty | .[] | select(.ok == false)] | length' test-results/results.json 2>/dev/null || echo "0")
            echo "JSON parsing: total=$TOTAL_TESTS, passed=$PASSED_TESTS, failed=$FAILED_TESTS"
            echo "::endgroup::"
          elif [ -f "test-results/junit.xml" ]; then
            echo "::group::Parsing JUnit XML"
            # Count total test cases
            TOTAL_TESTS=$(grep -c "<testcase" test-results/junit.xml 2>/dev/null || echo "0")
            # Count failures
            FAILED_TESTS=$(grep -c "<failure" test-results/junit.xml 2>/dev/null || echo "0")
            # Calculate passed tests (total - failed)
            PASSED_TESTS=$((TOTAL_TESTS - FAILED_TESTS))
            echo "JUnit parsing: total=$TOTAL_TESTS, passed=$PASSED_TESTS, failed=$FAILED_TESTS"
            echo "::endgroup::"
          else
            echo "::group::Fallback: counting directories"
            # Fallback: count test result directories
            TOTAL_TESTS=$(find test-results -type d -name "*chromium*" 2>/dev/null | wc -l | tr -d ' ' || echo "0")
            PASSED_TESTS=$(find test-results -type d -name "*chromium*" ! -name "*retry*" 2>/dev/null | wc -l | tr -d ' ' || echo "0")
            FAILED_TESTS=$(find test-results -type d -name "*retry*" 2>/dev/null | wc -l | tr -d ' ' || echo "0")
            echo "Directory counting: total=$TOTAL_TESTS, passed=$PASSED_TESTS, failed=$FAILED_TESTS"
            echo "::endgroup::"
          fi

          VISUAL_DIFFS=$(find test-results -name "*-diff.png" 2>/dev/null | wc -l | tr -d ' ' || echo "0")

          echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
          echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
          echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
          echo "visual_diffs=$VISUAL_DIFFS" >> $GITHUB_OUTPUT

          # Determine status: use test step outcome as primary signal, metrics as secondary
          TEST_OUTCOME="${{ steps.test.outcome }}"
          if [ "$TEST_OUTCOME" = "success" ] && [ "$FAILED_TESTS" -eq "0" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          elif [ "$FAILED_TESTS" -gt "0" ] || [ "$TEST_OUTCOME" = "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi

          # Forward test timing from the test step
          TEST_TIME_SEC="${{ steps.test.outputs.test_time_sec }}"
          echo "test_time_sec=${TEST_TIME_SEC:-N/A}" >> $GITHUB_OUTPUT

          # Check test time budget from config
          CONFIG_FILE="${GITHUB_WORKSPACE}/.github/config/performance-budgets.json"
          if [ -f "$CONFIG_FILE" ] && [ "${TEST_TIME_SEC}" != "" ] && [ "${TEST_TIME_SEC}" != "N/A" ]; then
            TEST_BUDGET=$(jq -r '.budgets.timing.tests.max' "$CONFIG_FILE" 2>/dev/null || echo "")
            if [ -n "$TEST_BUDGET" ] && [ "$TEST_BUDGET" != "null" ]; then
              echo "test_budget=${TEST_BUDGET}" >> $GITHUB_OUTPUT
              if (( $(echo "${TEST_TIME_SEC} > ${TEST_BUDGET}" | bc -l) )); then
                echo "‚ö†Ô∏è  Test time budget exceeded: ${TEST_TIME_SEC}s > ${TEST_BUDGET}s"
                echo "test_time_pass=warning" >> $GITHUB_OUTPUT
              else
                echo "‚úÖ Test time within budget: ${TEST_TIME_SEC}s <= ${TEST_BUDGET}s"
                echo "test_time_pass=true" >> $GITHUB_OUTPUT
              fi
            else
              echo "test_budget=" >> $GITHUB_OUTPUT
              echo "test_time_pass=N/A" >> $GITHUB_OUTPUT
            fi
          else
            echo "test_budget=" >> $GITHUB_OUTPUT
            echo "test_time_pass=N/A" >> $GITHUB_OUTPUT
          fi

          echo "::notice::Metrics - Total: $TOTAL_TESTS, Passed: $PASSED_TESTS, Failed: $FAILED_TESTS, Diffs: $VISUAL_DIFFS, Time: ${TEST_TIME_SEC:-N/A}s"

      # Step 7: Upload test results on failure
      - name: üì¶ Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-test-results
          path: packages/design-system/playwright/test-results/
          retention-days: 7

      # Step 8: Upload Playwright trace on failure
      - name: üì¶ Upload Playwright trace
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-trace
          path: packages/design-system/playwright/test-results/**/*.zip
          retention-days: 7

      # Step 9: Upload HTML report on failure
      - name: üì¶ Upload HTML report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-html-report
          path: packages/design-system/playwright/playwright-report/
          retention-days: 7

      # Step 10: Upload visual diffs
      - name: üì¶ Upload visual diffs
        if: steps.metrics.outputs.visual_diffs != '0'
        uses: actions/upload-artifact@v6
        with:
          name: visual-diffs
          path: packages/design-system/playwright/test-results/**/*-diff.png
          retention-days: 14

      # Step 10b: Upload baseline snapshots
      - name: üì¶ Upload baseline snapshots
        if: steps.metrics.outputs.visual_diffs != '0'
        uses: actions/upload-artifact@v6
        with:
          name: baseline-snapshots
          path: packages/design-system/playwright/__snapshots__/**/*.png
          retention-days: 7

      # Step 11: Build detailed PR comment
      - name: üìù Build PR comment
        if: github.event_name == 'pull_request' && always() && !contains(github.event.pull_request.labels.*.name, 'snapshot-update')
        id: comment
        env:
          STATUS: ${{ steps.metrics.outputs.status }}
          TOTAL_TESTS: ${{ steps.metrics.outputs.total_tests }}
          PASSED_TESTS: ${{ steps.metrics.outputs.passed_tests }}
          FAILED_TESTS: ${{ steps.metrics.outputs.failed_tests }}
          VISUAL_DIFFS: ${{ steps.metrics.outputs.visual_diffs }}
          TEST_TIME_SEC: ${{ steps.metrics.outputs.test_time_sec }}
          TEST_BUDGET: ${{ steps.metrics.outputs.test_budget }}
          TEST_TIME_PASS: ${{ steps.metrics.outputs.test_time_pass }}
          RUN_ID: ${{ github.run_id }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          ARTIFACT_URL="https://github.com/${REPO_OWNER}/${REPO_NAME}/actions/runs/${RUN_ID}"

          cat << 'EOF' > comment.md
          <!-- playwright-ct-results -->
          ## üé≠ Playwright Component Test Results

          EOF

          if [ "$STATUS" = "success" ]; then
            cat << 'EOF' >> comment.md
          ### ‚úÖ All Tests Passed!

          No visual regressions detected. All components render as expected! üéâ

          EOF
          else
            cat << 'EOF' >> comment.md
          ### ‚ö†Ô∏è Test Failures Detected

          Some tests failed or visual differences were detected. Please review below.

          EOF
          fi

          cat << EOF >> comment.md
          | Metric | Count |
          |--------|-------|
          | Total Tests | ${TOTAL_TESTS} |
          | Passed | ${PASSED_TESTS} $([ "$STATUS" = "success" ] && echo "‚úÖ" || echo "") |
          | Failed | ${FAILED_TESTS} $([ "$STATUS" != "success" ] && echo "‚ùå" || echo "") |
          | Visual Diffs | ${VISUAL_DIFFS} $([ "$VISUAL_DIFFS" != "0" ] && echo "üîç" || echo "") |
          EOF

          # Add execution time row with budget info if available
          if [ -n "$TEST_BUDGET" ]; then
            if [ "$TEST_TIME_PASS" = "true" ]; then
              TIME_STATUS="‚úÖ"
            elif [ "$TEST_TIME_PASS" = "warning" ]; then
              TIME_STATUS="‚ö†Ô∏è"
            else
              TIME_STATUS=""
            fi
            cat << EOF >> comment.md
          | Execution Time | ${TEST_TIME_SEC}s / ${TEST_BUDGET}s ${TIME_STATUS} |
          EOF
          else
            cat << EOF >> comment.md
          | Execution Time | ${TEST_TIME_SEC}s |
          EOF
          fi

          echo "" >> comment.md

          if [ "$VISUAL_DIFFS" != "0" ]; then
            cat << EOF >> comment.md
          ### üì∏ Visual Differences

          ${VISUAL_DIFFS} component(s) have visual differences from the baseline snapshots.

          **Review Artifacts:**
          - [üì¶ Visual Diffs](${ARTIFACT_URL}#artifacts) - Download diff images
          - [üìä Test Report](${ARTIFACT_URL}#artifacts) - Full Playwright HTML report
          - [üñºÔ∏è Baseline Snapshots](${ARTIFACT_URL}#artifacts) - Current baseline images

          ### üí° How to Review

          1. Download the \`visual-diffs\` artifact from the [Actions run](${ARTIFACT_URL})
          2. Review each diff image (red = removed, green = added)
          3. If changes are intentional:
             - Add label \`snapshot-update\` to this PR
             - Automated workflow will update baselines
          4. If changes are unintentional:
             - Fix the component code
             - Push changes to re-run tests

          EOF
          fi

          cat << 'EOF' >> comment.md
          ### üìã Components Tested

          All design system components were tested in:
          - ‚òÄÔ∏è Light mode
          - üåô Dark mode
          - üíª Desktop viewport (1280x720)

          **Tested Components:**
          - Box, Stack, Text, Icon
          - Button, Badge, Divider
          - Center, Container, Flex, Grid
          - Portal, VisuallyHidden, Label
          - Input, Card (compositions)

          EOF

          if [ "$STATUS" != "success" ] || [ "$VISUAL_DIFFS" != "0" ]; then
            cat << EOF >> comment.md
          ### üîß Troubleshooting

          **Common causes of test failures or visual differences:**
          1. **Token changes** - Updated design tokens affect component styling
          2. **CSS changes** - Modified component styles or utility classes
          3. **Font changes** - Font family or weight modifications
          4. **Layout changes** - Padding, margin, or sizing adjustments
          5. **Browser updates** - Rendering engine differences

          **Run tests locally:**
          \`\`\`bash
          # Run component tests
          pnpm ds:test:ci

          # Update snapshots if changes are intentional
          pnpm ds:test:update-snapshots

          # Run tests in UI mode for debugging
          pnpm ds:test:ui
          \`\`\`

          EOF
          fi

          cat << EOF >> comment.md
          ---

          *üìä [View full test report](${ARTIFACT_URL})*
          EOF

          echo "body<<EOFMARKER" >> $GITHUB_OUTPUT
          cat comment.md >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT

      # Step 12: Comment on PR
      - name: üí¨ Comment on PR
        if: github.event_name == 'pull_request' && always() && !contains(github.event.pull_request.labels.*.name, 'snapshot-update')
        uses: ./.github/actions/pr-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-marker: '<!-- playwright-ct-results -->'
          comment-body: ${{ steps.comment.outputs.body }}

      # Step 13: Fail if tests failed
      - name: ‚ùå Fail if tests failed
        if: steps.metrics.outputs.status == 'failure' || steps.test.outcome == 'failure'
        run: |
          echo "::error::Component tests failed. Review artifacts and logs for details."
          exit 1

      # Step 14: Success message if all tests passed
      - name: ‚úÖ Tests passed
        if: steps.metrics.outputs.status == 'success' && steps.test.outcome == 'success'
        run: |
          echo "::notice::All visual regression tests passed! üéâ"

  update-linux-snapshots:
    name: Update Linux Snapshots
    runs-on: ubuntu-latest
    timeout-minutes: 60
    # Only run when the 'snapshot-update' label is added to a PR
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'snapshot-update')

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: üîß Configure Git
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

      - name: üì¶ Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üèóÔ∏è Build design system
        uses: ./.github/actions/build-design-system
        with:
          build-storybook: 'false'
          build-docusaurus: 'false'

      # Step 4: Install Playwright browsers
      - name: Install Playwright browsers
        uses: ./.github/actions/install-playwright

      # Step 6: Update Linux snapshots
      - name: Update Linux snapshots
        run: pnpm --filter @grasdouble/lufa_design-system-playwright test-ct --update-snapshots=all
        env:
          CI: true

      # Step 7: Setup Rust toolchain
      - name: Setup Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # Step 8: Cache cargo dependencies
      - name: Cache cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-oxipng-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-oxipng-

      # Step 9: Install oxipng
      - name: Install oxipng
        run: |
          # Check if oxipng is already cached
          if ! command -v oxipng &> /dev/null; then
            echo "Installing oxipng via cargo..."
            cargo install oxipng
          else
            echo "oxipng already cached"
          fi

          # Verify installation
          oxipng --version

      # Step 10: Compress snapshots (level 6 for CI artifacts)
      - name: Compress snapshots
        run: pnpm ds:test:compress-snapshots
        # Note: We compress manually with level 6 (maximum) before committing.
        # The pre-commit hook (level 3) will run during git commit but won't
        # re-compress already optimized files. This ensures CI snapshots get
        # maximum compression (~10% better than level 3) while the hook still
        # validates that compression is working correctly.

      # Step 11: Commit and push updated snapshots
      - name: Commit and push snapshots
        id: commit
        run: |
          git add packages/design-system/playwright/__snapshots__/

          # Check if there are any changes
          if git diff --staged --quiet; then
            echo "No snapshot changes detected"
            echo "updated=false" >> $GITHUB_OUTPUT
          else
            # Pre-commit hook will run here but won't re-compress (files already optimized)
            git commit -m "test: update Linux snapshots (automated)"
            git push
            echo "updated=true" >> $GITHUB_OUTPUT
            echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
          fi

      # Step 12: Trigger test workflow on the new commit
      - name: Trigger tests on updated snapshots
        if: steps.commit.outputs.updated == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            // Wait for the push to be processed
            console.log('Waiting 5 seconds for push to be processed...');
            await new Promise(resolve => setTimeout(resolve, 5000));

            // Trigger the workflow again with workflow_dispatch
            try {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: 'tools-ds-playwright-ct.yml',
                ref: '${{ github.event.pull_request.head.ref }}',
                inputs: {
                  pr_number: String(context.issue.number)
                }
              });
              console.log('Successfully triggered workflow for PR #' + context.issue.number);
            } catch (error) {
              console.error('Failed to trigger workflow:', error.message);
              // Non-blocking error - tests will still run on next push
            }

      # Step 15: Comment on PR - Success
      - name: Comment on PR - Success
        if: steps.commit.outputs.updated == 'true'
        uses: ./.github/actions/pr-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-marker: '<!-- playwright-ct-results -->'
          comment-body: |
            <!-- playwright-ct-results -->
            ‚úÖ Linux snapshots have been updated and compressed!

            **Changes:**
            - Updated Linux snapshots in `packages/design-system/playwright/__snapshots__/`
            - Compressed snapshots using oxipng (level 6)
            - Committed with message: "test: update Linux snapshots (automated)"
            - New commit SHA: `${{ steps.commit.outputs.sha }}`

            **Next steps:**
            1. ‚úÖ Workflow has been triggered to run tests on updated snapshots
            2. Pull the latest changes: `git pull`
            3. Review the snapshot changes in the "Files changed" tab
            4. Merge when tests pass

            _The `snapshot-update` label has been automatically removed._

      # Step 16: Comment on PR - No changes
      - name: Comment on PR - No changes
        if: steps.commit.outputs.updated == 'false'
        uses: ./.github/actions/pr-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-marker: '<!-- playwright-ct-results -->'
          comment-body: |
            <!-- playwright-ct-results -->
            ‚ÑπÔ∏è No snapshot changes detected.

            The existing Linux snapshots are already up to date.

            _The `snapshot-update` label has been automatically removed._

      # Step 17: Remove snapshot-update label
      - name: Remove snapshot-update label
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            try {
              await github.rest.issues.removeLabel({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'snapshot-update'
              })
              console.log('Label removed successfully')
            } catch (error) {
              // Label might already be removed or not exist
              console.log('Could not remove label:', error.message)
            }
