name: DS:Tools:Main:Validate Components

on:
  pull_request:
    paths:
      - 'packages/design-system/main/src/**/*.tsx'
      - 'packages/design-system/main/src/**/*.ts'
      - '.github/workflows/tools-ds-main-validate-components.yml'
  push:
    branches:
      - main
    paths:
      - 'packages/design-system/main/src/**/*.tsx'
      - 'packages/design-system/main/src/**/*.ts'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    name: Validate Components
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v6

      - name: üì¶ Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üèóÔ∏è Build design system
        uses: ./.github/actions/build-design-system
        with:
          build-storybook: 'false'
          build-docusaurus: 'false'

      - name: üîç Validate component code quality
        id: validate_code
        run: |
          echo "::group::Component Code Validation"
          pnpm validate:components
          echo "::endgroup::"
        continue-on-error: true

      - name: üìä Analyze validation results
        id: analyze
        run: |
          VALIDATE_CODE_STATUS="${{ steps.validate_code.outcome }}"

          echo "validate_code_status=$VALIDATE_CODE_STATUS" >> $GITHUB_OUTPUT

          # Determine overall status
          if [[ "$VALIDATE_CODE_STATUS" == "success" ]]; then
            echo "overall_status=success" >> $GITHUB_OUTPUT
          else
            echo "overall_status=failure" >> $GITHUB_OUTPUT
          fi

      - name: üìù Build PR comment body
        if: github.event_name == 'pull_request'
        id: comment
        env:
          VALIDATE_CODE_STATUS: ${{ steps.analyze.outputs.validate_code_status }}
          OVERALL_STATUS: ${{ steps.analyze.outputs.overall_status }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          status_emoji() {
            if [ "$1" = "success" ]; then
              echo "‚úÖ"
            else
              echo "‚ùå"
            fi
          }

          cat << 'EOF' > comment.md
          <!-- component-validation-report -->
          ## üîç Component Validation Report

          EOF

          if [ "$OVERALL_STATUS" = "success" ]; then
            cat << 'EOF' >> comment.md
          ### ‚úÖ All Checks Passed!

          All component validation checks completed successfully. Great work! üéâ

          EOF
          else
            cat << 'EOF' >> comment.md
          ### ‚ö†Ô∏è Some Checks Failed

          Please review and fix the issues below:

          EOF
          fi

          cat << EOF >> comment.md
          | Check | Status |
          |-------|--------|
          | Code Quality | $(status_emoji "$VALIDATE_CODE_STATUS") $([ "$VALIDATE_CODE_STATUS" = "success" ] && echo "Passed" || echo "Failed") |

          **Note:** Component tests are run separately in the [Playwright Component Tests workflow](../../actions/workflows/tools-ds-playwright-ct.yml).

          EOF

          if [ "$OVERALL_STATUS" != "success" ]; then
            cat << 'EOF' >> comment.md
          ### üí° How to Fix

          EOF
            
            if [ "$VALIDATE_CODE_STATUS" != "success" ]; then
              cat << 'EOF' >> comment.md
          **Code Quality Failed:**
          - Run locally: `pnpm validate:components`
          - Fix hard-coded values (use design tokens)
          - Add missing prop descriptions
          - Export TypeScript types

          EOF
            fi
            
            cat << EOF >> comment.md
          ### üìö Resources

          - üìñ [Design System Documentation](https://github.com/${REPO_OWNER}/${REPO_NAME}/blob/main/packages/design-system/README.md)
          - üß™ Run all checks: \`pnpm validate:components\`
          - üé≠ Component tests: See [Playwright Component Tests workflow](https://github.com/${REPO_OWNER}/${REPO_NAME}/actions/workflows/tools-ds-playwright-ct.yml)

          EOF
          fi

          cat << 'EOF' >> comment.md
          ---

          EOF

          echo "body<<EOFMARKER" >> $GITHUB_OUTPUT
          cat comment.md >> $GITHUB_OUTPUT
          echo "EOFMARKER" >> $GITHUB_OUTPUT

      - name: üí¨ Comment on PR with results
        if: github.event_name == 'pull_request'
        uses: ./.github/actions/pr-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-marker: '<!-- component-validation-report -->'
          comment-body: ${{ steps.comment.outputs.body }}

      - name: ‚ùå Fail if validation errors
        if: steps.analyze.outputs.overall_status == 'failure'
        run: |
          echo "::error::Component validation failed. See validation report above."
          exit 1

      - name: ‚úÖ Validation successful
        if: steps.analyze.outputs.overall_status == 'success'
        run: |
          echo "::notice::All component validation checks passed! üéâ"
