name: Tools:DS:Tokens:Validate Design Tokens

on:
  pull_request:
    paths:
      - 'packages/design-system/tokens/src/**/*.json'
      - 'scripts/validate-token-metadata.js'
  push:
    branches:
      - main
    paths:
      - 'packages/design-system/tokens/src/**/*.json'
      - 'scripts/validate-token-metadata.js'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-tokens:
    name: Validate Token Metadata
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v6

      - name: üì¶ Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üîç Run token validation
        id: validate
        run: |
          echo "::group::Token Validation"
          node scripts/validate-token-metadata.js
          echo "::endgroup::"
        continue-on-error: true

      - name: üí¨ Build validation comment
        if: github.event_name == 'pull_request' && steps.validate.outcome == 'failure'
        id: build-comment
        run: |
          # Re-run validation to capture output
          VALIDATION_OUTPUT=$(node scripts/validate-token-metadata.js 2>&1 || true)

          # Parse validation errors
          ERROR_COUNT=$(echo "$VALIDATION_OUTPUT" | grep -oP '‚úó Tokens with Errors: \K\d+' || echo "0")
          WARNING_COUNT=$(echo "$VALIDATION_OUTPUT" | grep -oP '‚ö† Warnings: \K\d+' || echo "0")

          # Build comment body with heredoc
          {
            echo 'comment-body<<EOF_COMMENT'
            cat << EOF
          <!-- token-validation-comment -->
          ## üîç Design Token Validation

          ### ‚ùå Validation Failed

          **Errors:** ${ERROR_COUNT} | **Warnings:** ${WARNING_COUNT}

          <details>
          <summary>üìã Validation Report</summary>

          \`\`\`
          ${VALIDATION_OUTPUT}
          \`\`\`

          </details>

          ### üí° How to Fix

          All tokens must include:

          1. **\`\$description\`** - Meaningful description (min 10 chars)
             - ‚úÖ Good: "Primary brand color used for buttons, links, and key actions"
             - ‚ùå Bad: "Primary color"

          2. **\`\$type\`** - Valid DTCG type (color, dimension, fontFamily, etc.)

          3. **\`\$extensions.lufa.themable\`** - Set to \`true\` or \`false\`

          ### üìö Resources

          - üìñ [Your First Token Guide](https://github.com/${{ github.repository }}/blob/main/docs/contributors/your-first-token.md)
          - ‚úÇÔ∏è Use VSCode snippets: \`.vscode/lufa-tokens.code-snippets\`
          - üß™ Run locally: \`pnpm validate:tokens\`

          ---

          *Part of Lufa Design System v2.0 - Automated token validation*
          EOF
            echo 'EOF_COMMENT'
          } >> $GITHUB_OUTPUT

      - name: üí¨ Comment on PR with results
        if: github.event_name == 'pull_request' && steps.validate.outcome == 'failure'
        uses: ./.github/actions/pr-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-marker: '<!-- token-validation-comment -->'
          comment-body: ${{ steps.build-comment.outputs.comment-body }}

      - name: ‚ùå Fail if validation errors
        if: steps.validate.outcome == 'failure'
        run: |
          echo "::error::Token validation failed. See validation report above."
          exit 1

      - name: ‚úÖ Validation successful
        if: steps.validate.outcome == 'success'
        run: |
          echo "::notice::All tokens have valid metadata!"
