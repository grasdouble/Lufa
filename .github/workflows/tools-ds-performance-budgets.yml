name: Tools:DS:Performance-Budgets

on:
  pull_request:
    paths:
      - 'packages/design-system/main/src/**/*.tsx'
      - 'packages/design-system/main/src/**/*.ts'
      - 'packages/design-system/main/src/**/*.css'
      - 'packages/design-system/tokens/**/*.json'
      - 'packages/design-system/main/vite.config.ts'
      - 'packages/design-system/main/package.json'
      - '.github/workflows/tools-ds-performance-budgets.yml'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  performance-budgets:
    name: Performance Budgets
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v6

      - name: üì¶ Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: üèóÔ∏è Build design system
        uses: ./.github/actions/build-design-system
        with:
          build-storybook: 'false'
          build-docusaurus: 'false'

      - name: üìä Run performance checks
        id: perf
        run: |
          echo "::group::Performance Checks"

          # Create results directory
          mkdir -p performance-results

          # 1. Build Time Measurement
          echo "üì¶ Measuring build time..."
          BUILD_START=$(date +%s%3N)
          # Build is already done via reusable workflow and cached
          # Just restore from cache to measure cache performance
          BUILD_END=$(date +%s%3N)
          BUILD_TIME=$((BUILD_END - BUILD_START))
          BUILD_TIME_SEC=$(echo "scale=2; $BUILD_TIME / 1000" | bc)
          echo "build_time=${BUILD_TIME_SEC}" >> $GITHUB_OUTPUT
          echo "‚úÖ Build time (from cache): ${BUILD_TIME_SEC}s"

          # 2. Bundle Size Check
          echo ""
          echo "üì¶ Measuring bundle size..."
          cd packages/design-system/main

          # Get file sizes
          if [ -f "dist/lufa-ui.mjs" ]; then
            BUNDLE_SIZE=$(stat -c%s "dist/lufa-ui.mjs" 2>/dev/null || stat -f%z "dist/lufa-ui.mjs")
            BUNDLE_SIZE_KB=$(echo "scale=2; $BUNDLE_SIZE / 1024" | bc)
            echo "bundle_size_kb=${BUNDLE_SIZE_KB}" >> $GITHUB_OUTPUT
            echo "‚úÖ Bundle size: ${BUNDLE_SIZE_KB} KB"
          else
            echo "bundle_size_kb=0" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Bundle file not found"
          fi

          if [ -f "dist/style.css" ]; then
            CSS_SIZE=$(stat -c%s "dist/style.css" 2>/dev/null || stat -f%z "dist/style.css")
            CSS_SIZE_KB=$(echo "scale=2; $CSS_SIZE / 1024" | bc)
            echo "css_size_kb=${CSS_SIZE_KB}" >> $GITHUB_OUTPUT
            echo "‚úÖ CSS size: ${CSS_SIZE_KB} KB"
          else
            echo "css_size_kb=0" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è CSS file not found"
          fi

          # Calculate total size
          TOTAL_SIZE=$(echo "$BUNDLE_SIZE_KB + $CSS_SIZE_KB" | bc)
          echo "total_size_kb=${TOTAL_SIZE}" >> $GITHUB_OUTPUT
          echo "‚úÖ Total size: ${TOTAL_SIZE} KB"

          # Check if gzip exists
          if command -v gzip &> /dev/null; then
            # Gzipped size
            GZIP_SIZE=$(gzip -c "dist/lufa-ui.mjs" | wc -c)
            GZIP_SIZE_KB=$(echo "scale=2; $GZIP_SIZE / 1024" | bc)
            echo "gzip_size_kb=${GZIP_SIZE_KB}" >> $GITHUB_OUTPUT
            echo "‚úÖ Gzipped JS size: ${GZIP_SIZE_KB} KB"
          else
            echo "gzip_size_kb=N/A" >> $GITHUB_OUTPUT
          fi

          cd ../../..

          # 3. Test Execution Time
          echo ""
          echo "üß™ Measuring test execution time..."
          TEST_START=$(date +%s%3N)
          pnpm --filter @grasdouble/lufa_design-system-playwright test-ct --project=chromium --reporter=list > /tmp/test-output.txt 2>&1 || true
          TEST_END=$(date +%s%3N)
          TEST_TIME=$((TEST_END - TEST_START))
          TEST_TIME_SEC=$(echo "scale=2; $TEST_TIME / 1000" | bc)
          echo "test_time=${TEST_TIME_SEC}" >> $GITHUB_OUTPUT
          echo "‚úÖ Test execution time: ${TEST_TIME_SEC}s"

          # 4. CSS Cascade Performance (CLI validation from Phase 7a)
          echo ""
          echo "üé® Measuring CSS cascade performance..."
          cd packages/design-system/cli

          # Create test theme for validation
          cat > /tmp/test-theme.css << 'EOF'
          [data-mode="light"] {
            --lufa-semantic-ui-text-primary: var(--lufa-core-neutral-text-primary);
            --lufa-semantic-ui-bg-primary: var(--lufa-core-neutral-bg-primary);
            --lufa-core-neutral-text-primary: var(--lufa-primitive-color-gray-900);
            --lufa-core-neutral-bg-primary: var(--lufa-primitive-color-white);
            --lufa-primitive-color-gray-900: #111827;
            --lufa-primitive-color-white: #ffffff;
          }
          EOF

          # Run cascade validation
          CASCADE_START=$(date +%s%3N)
          pnpm exec tsx src/index.ts validate --theme /tmp/test-theme.css --all > /tmp/cascade-output.txt 2>&1 || true
          CASCADE_END=$(date +%s%3N)
          CASCADE_TIME=$((CASCADE_END - CASCADE_START))
          CASCADE_TIME_MS=$((CASCADE_TIME))
          echo "cascade_time_ms=${CASCADE_TIME_MS}" >> $GITHUB_OUTPUT
          echo "‚úÖ CSS cascade validation time: ${CASCADE_TIME_MS}ms"

          cd ../../..

          # 5. Load performance budgets from config
          echo ""
          echo "üìä Loading performance budgets from config..."

          CONFIG_FILE=".github/config/performance-budgets.json"
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "‚ùå Config file not found: $CONFIG_FILE"
            exit 1
          fi

          # Load budgets using jq
          BUNDLE_BUDGET=$(jq -r '.budgets.bundle.totalSize.max' "$CONFIG_FILE")
          GZIP_BUDGET=$(jq -r '.budgets.bundle.gzipped.max' "$CONFIG_FILE")
          BUILD_BUDGET=$(jq -r '.budgets.timing.build.max' "$CONFIG_FILE")
          TEST_BUDGET=$(jq -r '.budgets.timing.tests.max' "$CONFIG_FILE")
          CASCADE_BUDGET=$(jq -r '.budgets.timing.cssCascade.max' "$CONFIG_FILE")

          echo "‚úÖ Loaded budgets:"
          echo "   - Bundle: ${BUNDLE_BUDGET} KB"
          echo "   - Gzipped: ${GZIP_BUDGET} KB"
          echo "   - Build: ${BUILD_BUDGET}s"
          echo "   - Tests: ${TEST_BUDGET}s"
          echo "   - CSS Cascade: ${CASCADE_BUDGET}ms"

          echo ""
          echo "üìä Checking performance budgets..."

          BUDGET_FAILURES=0

          # Bundle size budget
          # BUNDLE_BUDGET loaded from config
          if (( $(echo "$TOTAL_SIZE > $BUNDLE_BUDGET" | bc -l) )); then
            echo "‚ùå Bundle size budget exceeded: ${TOTAL_SIZE} KB > ${BUNDLE_BUDGET} KB"
            BUDGET_FAILURES=$((BUDGET_FAILURES + 1))
            echo "bundle_pass=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Bundle size within budget: ${TOTAL_SIZE} KB <= ${BUNDLE_BUDGET} KB"
            echo "bundle_pass=true" >> $GITHUB_OUTPUT
          fi

          # Gzipped size budget
          # GZIP_BUDGET loaded from config
          if [ "${GZIP_SIZE_KB}" != "N/A" ]; then
            # GZIP_BUDGET loaded from config
            if (( $(echo "$GZIP_SIZE_KB > $GZIP_BUDGET" | bc -l) )); then
              echo "‚ùå Gzipped size budget exceeded: ${GZIP_SIZE_KB} KB > ${GZIP_BUDGET} KB"
              BUDGET_FAILURES=$((BUDGET_FAILURES + 1))
              echo "gzip_pass=false" >> $GITHUB_OUTPUT
            else
              echo "‚úÖ Gzipped size within budget: ${GZIP_SIZE_KB} KB <= ${GZIP_BUDGET} KB"
              echo "gzip_pass=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "gzip_pass=N/A" >> $GITHUB_OUTPUT
          fi

          # Build time budget
          # BUILD_BUDGET loaded from config
          if (( $(echo "$BUILD_TIME_SEC > $BUILD_BUDGET" | bc -l) )); then
            echo "‚ùå Build time budget exceeded: ${BUILD_TIME_SEC}s > ${BUILD_BUDGET}s"
            BUDGET_FAILURES=$((BUDGET_FAILURES + 1))
            echo "build_pass=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Build time within budget: ${BUILD_TIME_SEC}s <= ${BUILD_BUDGET}s"
            echo "build_pass=true" >> $GITHUB_OUTPUT
          fi

          # Test time budget (657 tests)
          # TEST_BUDGET loaded from config
          if (( $(echo "$TEST_TIME_SEC > $TEST_BUDGET" | bc -l) )); then
            echo "‚ö†Ô∏è  Test time budget exceeded: ${TEST_TIME_SEC}s > ${TEST_BUDGET}s"
            # Warning only, don't fail
            echo "test_pass=warning" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Test time within budget: ${TEST_TIME_SEC}s <= ${TEST_BUDGET}s"
            echo "test_pass=true" >> $GITHUB_OUTPUT
          fi

          # CSS cascade budget
          # CASCADE_BUDGET loaded from config
          if (( CASCADE_TIME_MS > CASCADE_BUDGET )); then
            echo "‚ö†Ô∏è  CSS cascade time budget exceeded: ${CASCADE_TIME_MS}ms > ${CASCADE_BUDGET}ms"
            # Warning only, don't fail
            echo "cascade_pass=warning" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ CSS cascade time within budget: ${CASCADE_TIME_MS}ms <= ${CASCADE_BUDGET}ms"
            echo "cascade_pass=true" >> $GITHUB_OUTPUT
          fi

          # Overall status
          if [ $BUDGET_FAILURES -eq 0 ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo ""
            echo "‚úÖ All performance budgets passed!"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo ""
            echo "‚ùå ${BUDGET_FAILURES} performance budget(s) exceeded"
          fi

          echo "budget_failures=${BUDGET_FAILURES}" >> $GITHUB_OUTPUT

          echo "::endgroup::"

      - name: Install Playwright browsers
        if: always()
        uses: ./.github/actions/install-playwright

      - name: üìù Build comment body
        id: build-comment
        if: github.event_name == 'pull_request' && always()
        run: |
          # Extract all variables from previous step
          STATUS="${{ steps.perf.outputs.status }}"
          BUILD_TIME="${{ steps.perf.outputs.build_time }}"
          BUNDLE_SIZE="${{ steps.perf.outputs.bundle_size_kb }}"
          CSS_SIZE="${{ steps.perf.outputs.css_size_kb }}"
          TOTAL_SIZE="${{ steps.perf.outputs.total_size_kb }}"
          GZIP_SIZE="${{ steps.perf.outputs.gzip_size_kb }}"
          TEST_TIME="${{ steps.perf.outputs.test_time }}"
          CASCADE_TIME="${{ steps.perf.outputs.cascade_time_ms }}"
          BUDGET_FAILURES="${{ steps.perf.outputs.budget_failures }}"

          BUNDLE_PASS="${{ steps.perf.outputs.bundle_pass }}"
          GZIP_PASS="${{ steps.perf.outputs.gzip_pass }}"
          BUILD_PASS="${{ steps.perf.outputs.build_pass }}"
          TEST_PASS="${{ steps.perf.outputs.test_pass }}"
          CASCADE_PASS="${{ steps.perf.outputs.cascade_pass }}"

          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Load budgets from config for display in comment
          CONFIG_FILE=".github/config/performance-budgets.json"
          BUNDLE_BUDGET=$(jq -r '.budgets.bundle.totalSize.max' "$CONFIG_FILE")
          GZIP_BUDGET=$(jq -r '.budgets.bundle.gzipped.max' "$CONFIG_FILE")
          BUILD_BUDGET=$(jq -r '.budgets.timing.build.max' "$CONFIG_FILE")
          TEST_BUDGET=$(jq -r '.budgets.timing.tests.max' "$CONFIG_FILE")
          CASCADE_BUDGET=$(jq -r '.budgets.timing.cssCascade.max' "$CONFIG_FILE")

          # Determine status indicators
          if [ "$BUNDLE_PASS" = "true" ]; then
            BUNDLE_STATUS="‚úÖ Pass"
          else
            BUNDLE_STATUS="‚ùå Fail"
          fi

          if [ "$GZIP_PASS" = "true" ]; then
            GZIP_STATUS="‚úÖ Pass"
          elif [ "$GZIP_PASS" = "false" ]; then
            GZIP_STATUS="‚ùå Fail"
          else
            GZIP_STATUS="N/A"
          fi

          if [ "$BUILD_PASS" = "true" ]; then
            BUILD_STATUS="‚úÖ Pass"
          else
            BUILD_STATUS="‚ùå Fail"
          fi

          if [ "$TEST_PASS" = "true" ]; then
            TEST_STATUS="‚úÖ Pass"
          elif [ "$TEST_PASS" = "warning" ]; then
            TEST_STATUS="‚ö†Ô∏è Warning"
          else
            TEST_STATUS="‚ùå Fail"
          fi

          if [ "$CASCADE_PASS" = "true" ]; then
            CASCADE_STATUS="‚úÖ Pass"
          elif [ "$CASCADE_PASS" = "warning" ]; then
            CASCADE_STATUS="‚ö†Ô∏è Warning"
          else
            CASCADE_STATUS="‚ùå Fail"
          fi

          # Calculate gzip compression ratio
          if [ "$GZIP_SIZE" != "N/A" ]; then
            GZIP_RATIO=$(echo "scale=0; ($GZIP_SIZE / $TOTAL_SIZE) * 100" | bc)
          fi

          # Build the comment body
          cat > /tmp/comment.md << 'EOF'
          <!-- performance-budget-comment -->
          ## ‚ö° Performance Budget Report

          EOF

          # Add success/failure header
          if [ "$STATUS" = "success" ]; then
            cat >> /tmp/comment.md << 'EOF'
          ### ‚úÖ All Performance Budgets Passed!

          Your changes meet all performance requirements. Great work! üéâ

          EOF
          else
            cat >> /tmp/comment.md << EOF
          ### ‚ö†Ô∏è Performance Budget Exceeded

          ${BUDGET_FAILURES} performance budget(s) exceeded. Please review the metrics below.

          EOF
          fi

          # Add performance metrics table
          cat >> /tmp/comment.md << EOF
          ### üìä Performance Metrics

          | Metric | Current | Budget | Status |
          |--------|---------|--------|--------|
          | **Bundle Size** | ${TOTAL_SIZE} KB | ${BUNDLE_BUDGET} KB | ${BUNDLE_STATUS} |
          | **JS Size** | ${BUNDLE_SIZE} KB | - | ‚ÑπÔ∏è Info |
          | **CSS Size** | ${CSS_SIZE} KB | - | ‚ÑπÔ∏è Info |
          EOF

          # Add gzip row if available
          if [ "$GZIP_SIZE" != "N/A" ]; then
            cat >> /tmp/comment.md << EOF
          | **Gzipped Size** | ${GZIP_SIZE} KB | ${GZIP_BUDGET} KB | ${GZIP_STATUS} |
          EOF
          fi

          # Continue table
          cat >> /tmp/comment.md << EOF
          | **Build Time** | ${BUILD_TIME}s | ${BUILD_BUDGET}s | ${BUILD_STATUS} |
          | **Test Time** | ${TEST_TIME}s | ${TEST_BUDGET}s | ${TEST_STATUS} |
          | **CSS Cascade** | ${CASCADE_TIME}ms | ${CASCADE_BUDGET}ms | ${CASCADE_STATUS} |

          ### üì¶ Size Breakdown

          \`\`\`
          JavaScript: ${BUNDLE_SIZE} KB
          CSS:        ${CSS_SIZE} KB
          ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
          Total:      ${TOTAL_SIZE} KB
          EOF

          # Add gzip line if available
          if [ "$GZIP_SIZE" != "N/A" ]; then
            cat >> /tmp/comment.md << EOF
          Gzipped:    ${GZIP_SIZE} KB (${GZIP_RATIO}% compression)
          EOF
          fi

          # Timing breakdown
          cat >> /tmp/comment.md << EOF
          \`\`\`

          ### ‚è±Ô∏è Timing Breakdown

          \`\`\`
          Build:         ${BUILD_TIME}s
          Tests (657):   ${TEST_TIME}s
          CSS Cascade:   ${CASCADE_TIME}ms
          \`\`\`

          EOF

          # Add "How to Fix" section if there are failures
          if [ "$STATUS" != "success" ]; then
            cat >> /tmp/comment.md << 'EOF'
          ### üí° How to Fix

          EOF

            if [ "$BUNDLE_PASS" != "true" ]; then
              cat >> /tmp/comment.md << 'EOF'
          **Bundle Size Exceeded:**
          - Review component complexity and remove unused code
          - Check for duplicate dependencies or heavy libraries
          - Consider code splitting or lazy loading
          - Run `pnpm ds:main:build` locally to analyze bundle

          EOF
            fi
            
            if [ "$GZIP_PASS" = "false" ]; then
              cat >> /tmp/comment.md << 'EOF'
          **Gzipped Size Exceeded:**
          - Ensure code minification is working correctly
          - Remove comments and debug code
          - Check for repetitive code patterns

          EOF
            fi
            
            if [ "$BUILD_PASS" != "true" ]; then
              cat >> /tmp/comment.md << 'EOF'
          **Build Time Exceeded:**
          - Check for expensive build-time operations
          - Review Vite configuration for optimization opportunities
          - Consider incremental builds

          EOF
            fi
          fi

          # Add performance history and local run sections
          cat >> /tmp/comment.md << EOF
          ### üìà Performance History

          Track performance trends over time by comparing metrics across PRs.

          ### üîß Run Locally

          \`\`\`bash
          # Build and check bundle size
          pnpm ds:main:build
          ls -lh packages/design-system/main/dist/

          # Run performance tests
          pnpm ds:test

          # Run CLI validation
          cd packages/design-system/cli
          pnpm exec tsx src/index.ts validate --theme <theme.css> --all
          \`\`\`

          ---

          *Part of Lufa Design System v2.0 - Automated performance monitoring (Phase 7c)*
          *üìä [View detailed report](${RUN_URL})*
          EOF

          # Output the comment body to GITHUB_OUTPUT
          {
            echo "COMMENT_BODY<<PERF_EOF"
            cat /tmp/comment.md
            echo "PERF_EOF"
          } >> $GITHUB_OUTPUT

      - name: üí¨ Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: ./.github/actions/pr-comment
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          comment-marker: '<!-- performance-budget-comment -->'
          comment-body: ${{ steps.build-comment.outputs.COMMENT_BODY }}

      - name: ‚ùå Fail if budgets exceeded
        if: steps.perf.outputs.status == 'failure'
        run: |
          echo "::error::Performance budgets exceeded. Review the metrics and optimize your changes."
          exit 1

      - name: ‚úÖ Budgets passed
        if: steps.perf.outputs.status == 'success'
        run: |
          echo "::notice::All performance budgets passed! üéâ"
