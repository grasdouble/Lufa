name: Tools:DS:Docusaurus:Update Changelog Documentation

# Automatically updates docs/changelog.md from package CHANGELOG files
# Documentation: packages/design-system/docusaurus/scripts/README.md

on:
  # NOTE: /!\ Disabled for now because current solution will generate too many files in the repo after multiple releases.
  # Trigger when the changeset release workflow runs
  # workflow_run:
  #   workflows: ['Release:Changesets']
  #   types:
  #     - completed

  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-changelog-docs:
    runs-on: ubuntu-latest
    # Only run if release workflow succeeded or triggered manually
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: main

      - name: üì¶ Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: üì¶ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Get latest released version from CHANGELOG
        id: get_changelog_version
        run: |
          # Extract the latest version from the main package CHANGELOG.md
          CHANGELOG_VERSION=$(grep -m 1 "^## " packages/design-system/main/CHANGELOG.md | sed -E "s/## ([0-9]+\.[0-9]+\.[0-9]+).*/\1/")
          echo "changelog_version=${CHANGELOG_VERSION}" >> $GITHUB_OUTPUT
          echo "Latest released version in CHANGELOG: ${CHANGELOG_VERSION}"

      - name: Check if version snapshot already exists
        id: check_snapshot
        run: |
          RELEASED_VERSION="${{ steps.get_changelog_version.outputs.changelog_version }}"

          if [ -d "packages/design-system/docusaurus/versioned_docs/version-${RELEASED_VERSION}" ]; then
            echo "snapshot_exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Snapshot for ${RELEASED_VERSION} already exists"
          else
            echo "snapshot_exists=false" >> $GITHUB_OUTPUT
            echo "üì∏ No snapshot found for ${RELEASED_VERSION}, will create it"
          fi

      - name: Create version snapshot for new release
        if: steps.check_snapshot.outputs.snapshot_exists == 'false'
        id: create_snapshot
        run: |
          cd packages/design-system/docusaurus
          RELEASED_VERSION="${{ steps.get_changelog_version.outputs.changelog_version }}"

          echo "üì∏ Creating version snapshot for released version ${RELEASED_VERSION}..."
          echo "This snapshot represents the released state of the documentation."

          # Create snapshot of docs with the released version
          pnpm docusaurus docs:version ${RELEASED_VERSION}

          echo "‚úÖ Created versioned docs in versioned_docs/version-${RELEASED_VERSION}/"
          echo "snapshot_created=true" >> $GITHUB_OUTPUT
          echo "version=${RELEASED_VERSION}" >> $GITHUB_OUTPUT

      - name: Update changelog documentation
        run: pnpm --filter @grasdouble/lufa_design-system-docusaurus update-changelog

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet packages/design-system/docusaurus/; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'docs(changelog): update changelog documentation from package CHANGELOG'
          committer: GitHub Actions <noreply@github.com>
          author: GitHub Actions <noreply@github.com>
          branch: automation/update-changelog-docs
          delete-branch: true
          title: 'üìù Update Changelog Documentation'
          body: |
            ## Automated Changelog Update

            This PR automatically updates the changelog documentation page based on the latest package CHANGELOG.md files.

            ### Changes
            - Updated `docs/changelog.md` with recent releases
            - Updated `docusaurus.config.ts` with version dropdown entries
            - Synced with package CHANGELOG files
            ${{ steps.create_snapshot.outputs.snapshot_created == 'true' && format('- üì∏ Created version snapshot for v{0}', steps.create_snapshot.outputs.version) || '' }}

            ### Version Snapshot
            ${{ steps.create_snapshot.outputs.snapshot_created == 'true' && format('‚úÖ Created snapshot for released version **{0}**', steps.create_snapshot.outputs.version) || '‚úÖ Snapshot already exists for this version' }}

            ### Details
            - Triggered by: ${{ github.event_name }}
            - Workflow: ${{ github.workflow }}
            - Run: ${{ github.run_id }}

            ---
            *This is an automated pull request created by the changelog sync workflow.*
          labels: |
            documentation
            automation
            changelog
          assignees: ${{ github.actor }}

      - name: No changes detected
        if: steps.check_changes.outputs.has_changes == 'false'
        run: echo "‚ú® Changelog documentation is already up to date!"
